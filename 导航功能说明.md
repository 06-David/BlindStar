# BlindStar 导航功能集成对接文档

## 概述

本文档描述了BlindStar实时视频决策系统与导航功能的集成方案，定义了接口标准、数据流和集成架构。

## 当前系统架构

### 核心组件
```
BlindStar 实时分析系统
├── 视觉感知层
│   ├── YOLO目标检测 (core/yolo_detector.py)
│   ├── ZoeDepth深度估计 (core/depth_estimator.py)
│   └── 深度危险检测 (core/depth_hazard_detector.py)
├── 决策层
│   ├── 风险评估器 (core/risk_assessor.py)
│   ├── 行动规划器 (core/action_planner.py)
│   └── 决策引擎 (core/decision_engine.py)
├── 交互层
│   ├── TTS语音播报 (core/tts_engine.py)
│   └── 实时视频分析器 (core/realtime_video_analyzer.py)
└── 启动层
    └── 统一启动器 (realtime_launcher.py)
```

### 数据流架构
```
视频输入 → YOLO检测 → 深度估计 → 风险评估 → 决策规划 → 语音播报
    ↓           ↓          ↓          ↓          ↓
   帧数据    检测结果    深度信息    风险等级    行动建议
```

## 导航系统集成架构

### 集成层次结构
```
BlindStar + 导航集成系统
├── 感知融合层
│   ├── 视觉感知 (现有)
│   ├── GPS定位 (新增)
│   ├── 地图数据 (新增)
│   └── 传感器融合 (新增)
├── 决策融合层
│   ├── 局部避障决策 (现有)
│   ├── 全局路径规划 (新增)
│   ├── 动态路径调整 (新增)
│   └── 多模态决策融合 (新增)
├── 交互增强层
│   ├── 语音播报 (现有)
│   ├── 导航指令 (新增)
│   ├── 语音交互 (新增)
│   └── 触觉反馈 (新增)
└── 服务集成层
    ├── 高德地图API (新增)
    ├── POI查询服务 (新增)
    └── 路况信息服务 (新增)
```

## 接口定义

### 1. 导航状态接口

```python
from dataclasses import dataclass
from typing import Optional, List, Tuple
from enum import Enum

class NavigationMode(Enum):
    """导航模式"""
    ASSIST = "assist"      # 辅助模式：仅提供危险提醒
    GUIDE = "guide"        # 引导模式：提供方向指引
    FULL = "full"          # 完全导航：完整路径规划

class NavigationState(Enum):
    """导航状态"""
    IDLE = "idle"          # 空闲
    PLANNING = "planning"  # 路径规划中
    NAVIGATING = "navigating"  # 导航中
    REROUTING = "rerouting"    # 重新规划
    ARRIVED = "arrived"    # 已到达

@dataclass
class GPSLocation:
    """GPS位置信息"""
    latitude: float        # 纬度
    longitude: float       # 经度
    altitude: Optional[float] = None  # 海拔
    accuracy: Optional[float] = None  # 精度(米)
    timestamp: Optional[float] = None # 时间戳

@dataclass
class NavigationContext:
    """导航上下文信息"""
    current_location: Optional[GPSLocation]
    destination: Optional[GPSLocation]
    route_points: List[GPSLocation]
    current_instruction: Optional[str]
    distance_to_destination: Optional[float]
    estimated_time: Optional[int]
    navigation_mode: NavigationMode
    navigation_state: NavigationState
```

### 2. 决策融合接口

```python
@dataclass
class NavigationDecision:
    """导航决策"""
    # 全局导航指令
    global_instruction: Optional[str]  # "直行100米后右转"
    direction_angle: Optional[float]   # 目标方向角度
    distance_to_turn: Optional[float]  # 距离转弯点距离
    
    # 局部避障指令
    local_hazards: List[ObjectRisk]    # 当前检测到的风险
    avoidance_instruction: Optional[str]  # "左侧有障碍物，请右侧通行"
    
    # 融合决策
    priority_level: int                # 优先级：1-全局导航，2-局部避障，3-紧急避险
    final_instruction: str             # 最终播报指令
    action_type: str                   # 动作类型："navigate", "avoid", "emergency"

class NavigationDecisionFusion:
    """导航决策融合器"""
    
    def fuse_decisions(self, 
                      vision_decision: ActionPlan,
                      navigation_context: NavigationContext) -> NavigationDecision:
        """融合视觉决策和导航决策"""
        pass
    
    def prioritize_instructions(self, 
                              global_instruction: str,
                              local_instruction: str,
                              emergency_level: int) -> str:
        """指令优先级处理"""
        pass
```

### 3. 地图服务接口

```python
class MapService:
    """地图服务接口"""
    
    def get_route(self, 
                  start: GPSLocation, 
                  end: GPSLocation,
                  mode: str = "walking") -> List[GPSLocation]:
        """获取路径规划"""
        pass
    
    def get_nearby_pois(self, 
                       location: GPSLocation, 
                       radius: int = 500,
                       category: str = None) -> List[dict]:
        """获取附近POI"""
        pass
    
    def get_navigation_instruction(self,
                                 current: GPSLocation,
                                 route: List[GPSLocation]) -> str:
        """获取导航指令"""
        pass
```

## 集成实现方案

### 阶段一：基础集成 

**目标**: 在现有系统基础上添加导航功能支持

**实现内容**:
1. **导航上下文管理器**
   ```python
   # core/navigation_context.py
   class NavigationContextManager:
       def __init__(self):
           self.current_context = NavigationContext()
           self.map_service = MapService()
       
       def update_location(self, location: GPSLocation):
           """更新当前位置"""
           pass
       
       def set_destination(self, destination: GPSLocation):
           """设置目的地"""
           pass
   ```

2. **决策融合器**
   ```python
   # core/navigation_fusion.py
   class NavigationDecisionFusion:
       def __init__(self, vision_engine, navigation_context):
           self.vision_engine = vision_engine
           self.navigation_context = navigation_context
       
       def make_fused_decision(self, frame_data) -> NavigationDecision:
           # 获取视觉决策
           vision_decision = self.vision_engine.make_decision(frame_data)
           
           # 获取导航上下文
           nav_context = self.navigation_context.get_current_context()
           
           # 融合决策
           return self.fuse_decisions(vision_decision, nav_context)
   ```

3. **增强的实时分析器**
   ```python
   # core/realtime_video_analyzer.py (修改)
   class RealtimeVideoAnalyzer:
       def __init__(self, ..., enable_navigation=False, nav_mode="assist"):
           # 现有初始化代码
           self.enable_navigation = enable_navigation
           if enable_navigation:
               self.nav_context = NavigationContextManager()
               self.nav_fusion = NavigationDecisionFusion(...)
   ```

### 阶段二：功能完善 

**目标**: 完善导航功能和用户交互

**实现内容**:
1. **语音交互增强**
   - 支持语音输入目的地
   - 导航指令语音播报优化
   - 多语言支持

2. **地图服务集成**
   - 高德地图API集成
   - 离线地图支持
   - POI查询和推荐

3. **路径规划优化**
   - 考虑视障人士特殊需求
   - 避开危险区域
   - 实时路况调整

## 配置文件格式

### 导航配置文件 (config/navigation_config.yaml)

```yaml
navigation:
  # 基础设置
  enabled: true
  mode: "assist"  # assist, guide, full
  
  # GPS设置
  gps:
    update_interval: 1.0  # GPS更新间隔(秒)
    accuracy_threshold: 10.0  # 精度阈值(米)
    
  # 地图服务
  map_service:
    provider: "amap"  # 高德地图
    api_key: "${AMAP_API_KEY}"
    cache_enabled: true
    offline_maps: true
    
  # 路径规划
  routing:
    mode: "walking"
    avoid_stairs: true
    avoid_construction: true
    prefer_sidewalks: true
    
  # 语音设置
  voice:
    navigation_voice: true
    instruction_interval: 50  # 指令播报间隔(米)
    hazard_priority: true     # 危险提醒优先级
    
  # 决策融合
  fusion:
    vision_weight: 0.7        # 视觉决策权重
    navigation_weight: 0.3    # 导航决策权重
    emergency_override: true  # 紧急情况覆盖
```

## 使用示例

### 基础导航模式
```bash
# 启用导航辅助模式
python realtime_launcher.py --source 0 --enable-navigation --nav-mode assist

# 启用完整导航模式
python realtime_launcher.py --source 0 --enable-navigation --nav-mode full
```

### 编程接口使用
```python
from core.realtime_video_analyzer import RealtimeVideoAnalyzer
from core.navigation_context import GPSLocation

# 创建带导航功能的分析器
analyzer = RealtimeVideoAnalyzer(enable_navigation=True, nav_mode="guide")

# 设置目的地（推荐使用包装方法）
analyzer.set_navigation_destination(latitude=39.9042, longitude=116.4074)

# 开始分析
analyzer.start_analysis("0")
```

### 最小适配器示例（连接GPS与导航）
```python
"""
最小示例：将外部GPS提供者与实时视频分析器连接，实现导航上下文实时更新。
"""
import time
from core.realtime_video_analyzer import RealtimeVideoAnalyzer

class DummyGPS:
    def __iter__(self):
        # 模拟生成位置（请替换为真实GPS数据源回调/订阅）
        lat, lon = 39.9042, 116.4074
        while True:
            yield lat, lon
            time.sleep(1.0)

def main():
    analyzer = RealtimeVideoAnalyzer(enable_navigation=True, nav_mode="assist")
    analyzer.set_navigation_destination(latitude=39.905, longitude=116.41)
    
    # 启动视频分析（异步显示结果）
    analyzer.start_analysis(source="0", display_results=True)
    
    # 连接GPS，持续更新位置
    gps = DummyGPS()
    for lat, lon in gps:
        ok = analyzer.update_gps_location(latitude=lat, longitude=lon)
        if not ok:
            # 未启用导航或上下文未就绪
            break

if __name__ == "__main__":
    main()
```

## 数据流设计

### 输入数据流
```
视频帧 + GPS位置 + 地图数据 → 感知融合 → 决策融合 → 指令输出
```

### 决策优先级
1. **紧急避险** (最高优先级)
   - 碰撞预警
   - 危险障碍物
   - 紧急停止

2. **局部避障** (高优先级)
   - 动态障碍物避让
   - 路径微调
   - 安全提醒

3. **全局导航** (标准优先级)
   - 路径指引
   - 转弯提醒
   - 距离播报

## 测试计划

### 单元测试
- [ ] GPS定位精度测试
- [ ] 地图API调用测试
- [ ] 决策融合逻辑测试
- [ ] 语音指令生成测试

### 集成测试
- [ ] 视觉+导航融合测试
- [ ] 实时性能测试
- [ ] 多场景适应性测试
- [ ] 用户体验测试

### 现场测试
- [ ] 室内导航测试
- [ ] 室外导航测试
- [ ] 复杂环境测试
- [ ] 长距离导航测试

## 部署和维护

### 部署要求
- GPS模块或定位服务
- 网络连接(地图服务)
- 足够的存储空间(离线地图)
- 实时性能保证

### 监控指标
- GPS定位精度
- 导航指令延迟
- 决策融合准确率
- 用户满意度

## 未来扩展

### 短期扩展 (6个月内)
- 室内定位支持
- 公共交通集成
- 社区地图标注

### 长期扩展 (1年内)
- AI路径学习
- 群体智能导航
- AR辅助显示

---

## 联系信息

**文档维护**: BlindStar开发团队  
**最后更新**: 2025-08-13  
**版本**: v1.0  

如有问题或建议，请联系开发团队或提交Issue。
