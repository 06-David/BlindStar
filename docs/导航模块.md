# BlindStar 导航模块文档

## 📖 模块概述

BlindStar导航模块提供智能导航和位置服务功能，集成高德地图API，为视障用户提供精确的POI查询、路径规划和实时导航指引。支持语音交互和多种导航模式。

## 🏗️ 架构设计

### 核心组件
- **导航上下文管理器** (`core/navigation_context.py`): 导航状态和上下文管理
- **高德地图集成** (`core/amap_navigation.py`): 地图API接口和导航服务
- **POI查询服务** (`core/poi_query.py`): 兴趣点搜索和信息获取
- **语音导航交互**: 与语音模块集成的导航命令处理

### 技术栈
- **高德地图API**: 提供地理信息服务、POI搜索、路径规划
- **GPS定位**: 实时位置获取和轨迹跟踪
- **语音交互**: 支持自然语言导航命令
- **离线缓存**: 关键导航数据本地缓存

## 🗺️ 导航上下文管理

### NavigationContextManager类
负责管理导航状态、GPS位置和路径跟踪：

```python
class NavigationContextManager:
    def __init__(self):
        self.current_location = None      # 当前GPS位置
        self.destination = None           # 目标位置
        self.navigation_mode = "assist"   # 导航模式
        self.route_points = []           # 路径点列表
        self.current_instruction = None   # 当前导航指令
```

### 导航模式
- **assist**: 辅助模式 - 基础位置和方向信息
- **guide**: 引导模式 - 详细路径指引和转向提示
- **full**: 完整模式 - 全功能导航包括实时交通信息

### GPS位置处理
```python
class GPSLocation:
    def __init__(self, latitude, longitude, accuracy=None):
        self.latitude = latitude          # 纬度
        self.longitude = longitude        # 经度
        self.accuracy = accuracy          # 定位精度(米)
        self.timestamp = time.time()      # 时间戳
        
    def distance_to(self, other_location):
        """计算到另一位置的距离(米)"""
        
    def bearing_to(self, other_location):
        """计算到另一位置的方位角(度)"""
```

## 🔍 POI查询服务

### 支持的POI类型
```python
POI_CATEGORIES = {
    '餐厅': ['餐厅', '饭店', '食堂', '快餐'],
    '咖啡厅': ['咖啡厅', '咖啡店', '茶馆'],
    '超市': ['超市', '便利店', '商店'],
    '银行': ['银行', 'ATM', '取款机'],
    '医院': ['医院', '诊所', '药店'],
    '交通': ['地铁站', '公交站', '火车站', '机场'],
    '购物': ['商场', '百货', '专卖店'],
    '服务': ['邮局', '加油站', '停车场']
}
```

### POI查询功能
```python
class POIQuery:
    def search_nearby_pois(self, location, category, radius=1000):
        """搜索附近POI"""
        
    def get_poi_details(self, poi_id):
        """获取POI详细信息"""
        
    def search_by_keyword(self, keyword, location, radius=1000):
        """关键词搜索POI"""
```

### 查询结果格式
```python
class POIResult:
    def __init__(self):
        self.name = ""              # POI名称
        self.address = ""           # 详细地址
        self.distance = 0           # 距离(米)
        self.bearing = 0            # 方位角(度)
        self.category = ""          # POI类别
        self.phone = ""             # 联系电话
        self.rating = 0.0           # 评分
        self.location = None        # GPS坐标
```

## 🧭 路径规划与导航

### 路径规划
```python
class RoutePlanner:
    def plan_route(self, start_location, end_location, mode="walking"):
        """规划路径"""
        # mode: "walking", "transit", "driving"
        
    def get_route_instructions(self, route):
        """获取详细导航指令"""
        
    def calculate_eta(self, route):
        """计算预计到达时间"""
```

### 导航指令类型
```python
class NavigationInstruction:
    STRAIGHT = "直行"
    LEFT = "左转"
    RIGHT = "右转"
    U_TURN = "掉头"
    ARRIVE = "到达目的地"
    
    def __init__(self, action, distance, description):
        self.action = action          # 动作类型
        self.distance = distance      # 距离(米)
        self.description = description # 详细描述
```

### 实时导航
```python
class RealTimeNavigation:
    def start_navigation(self, destination):
        """开始导航"""
        
    def update_location(self, current_location):
        """更新当前位置"""
        
    def get_next_instruction(self):
        """获取下一个导航指令"""
        
    def check_route_deviation(self):
        """检查是否偏离路线"""
```

## 🎯 语音导航交互

### 支持的语音命令

#### 目的地设置
```
- "导航到天安门"
- "去北京大学"
- "导航去最近的超市"
- "带我去咖啡厅"
```

#### 导航控制
```
- "开始导航"
- "暂停导航"
- "继续导航"
- "结束导航"
- "重新规划路线"
```

#### 信息查询
```
- "当前位置"
- "剩余距离"
- "预计到达时间"
- "下一个转弯"
- "附近有什么"
```

#### POI搜索
```
- "附近有什么餐厅"
- "查找最近的银行"
- "找咖啡厅"
- "搜索加油站"
```

### 语音反馈示例
```python
NAVIGATION_RESPONSES = {
    'route_planned': "路线规划完成，总距离{distance}米，预计{time}分钟到达",
    'navigation_started': "开始导航到{destination}",
    'next_instruction': "前方{distance}米后{action}",
    'arrived': "已到达目的地{destination}",
    'poi_found': "找到{count}个{category}，最近的距离{distance}米",
    'location_update': "当前位置：{address}，距离目的地还有{distance}米"
}
```

## ⚙️ 配置参数

### 高德地图API配置
```python
class AmapConfig:
    def __init__(self):
        self.api_key = ""                    # API密钥
        self.base_url = "https://restapi.amap.com"
        self.poi_search_radius = 1000        # POI搜索半径(米)
        self.max_poi_results = 10            # 最大POI结果数
        self.route_planning_mode = "walking" # 路径规划模式
        self.enable_traffic = True           # 启用实时交通
```

### 导航参数
```python
NAVIGATION_CONFIG = {
    'update_interval': 5.0,          # 位置更新间隔(秒)
    'route_deviation_threshold': 50, # 路线偏离阈值(米)
    'instruction_distance': 100,     # 提前播报距离(米)
    'poi_search_radius': 1000,       # POI搜索半径(米)
    'cache_expire_time': 3600,       # 缓存过期时间(秒)
    'voice_navigation': True,        # 启用语音导航
    'auto_reroute': True            # 自动重新规划路线
}
```

## 🛠️ 使用方法

### 基本导航使用
```python
from core.navigation_context import NavigationContextManager
from core.amap_navigation import AmapNavigation

# 初始化导航系统
nav_manager = NavigationContextManager()
amap_nav = AmapNavigation()

# 设置当前位置
current_pos = GPSLocation(39.9042, 116.4074)  # 天安门坐标
nav_manager.set_current_location(current_pos)

# 搜索POI
pois = amap_nav.search_nearby_pois(current_pos, "餐厅", radius=500)
print(f"找到{len(pois)}个餐厅")

# 开始导航
destination = pois[0].location
nav_manager.start_navigation(destination)
```

### 语音导航集成
```python
class VoiceNavigationHandler:
    def __init__(self, nav_manager, tts_engine):
        self.nav_manager = nav_manager
        self.tts = tts_engine
        
    def handle_navigation_command(self, command):
        if "导航到" in command:
            destination_name = self.extract_destination(command)
            self.start_navigation_to(destination_name)
        elif "附近" in command and any(poi in command for poi in POI_CATEGORIES):
            category = self.extract_poi_category(command)
            self.search_nearby_pois(category)
```

## 🔧 故障排除

### 常见问题

#### 1. GPS定位失败
```
原因: GPS信号弱或定位权限问题
解决: 
- 确保在开阔区域使用
- 检查应用定位权限
- 等待GPS信号稳定
```

#### 2. 高德地图API调用失败
```
原因: API密钥无效或网络问题
解决:
- 检查API密钥配置
- 确认网络连接正常
- 检查API调用频率限制
```

#### 3. 路径规划失败
```
原因: 起点终点无效或无可达路径
解决:
- 确认起点终点坐标正确
- 选择合适的出行方式
- 检查目的地是否可达
```

### 调试命令
```bash
# 测试GPS定位
python -c "from core.navigation_context import *; test_gps_location()"

# 测试POI查询
python -m core.poi_query --test

# 测试导航功能
python -m core.amap_navigation --test-navigation
```

## 📊 性能指标

### 定位精度
- **GPS精度**: 通常 < 10米
- **更新频率**: 1-5秒间隔
- **冷启动时间**: < 30秒

### API响应性能
- **POI查询**: < 2秒
- **路径规划**: < 3秒
- **实时导航**: < 1秒更新

### 功能覆盖
- **POI类别**: 支持8大类，50+子类别
- **导航模式**: 步行、公交、驾车
- **语音命令**: 支持20+种导航相关命令

## 🔄 更新日志

### v1.3 (当前版本)
- ✅ 实现NavigationContextManager导航上下文管理
- ✅ 添加三种导航模式支持
- ✅ 优化POI搜索和分类
- ✅ 集成语音导航交互

### v1.2
- ✅ 集成高德地图API
- ✅ 实现基础POI查询功能
- ✅ 添加路径规划能力

### v1.1
- ✅ GPS定位功能实现
- ✅ 基础导航框架搭建
- ✅ 位置信息语音播报

## 📚 相关文档
- [语音模块文档](./语音模块.md)
- [检测模块文档](./检测模块.md)
- [NAVIGATION_INTEGRATION.md](./NAVIGATION_INTEGRATION.md)
- [系统配置文档](./configuration.md)
