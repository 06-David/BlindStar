# BlindStar ç›¸æœºæ¨¡å—æ–‡æ¡£

## ğŸ“– æ¨¡å—æ¦‚è¿°

BlindStarç›¸æœºæ¨¡å—è´Ÿè´£è§†é¢‘æµçš„æ•è·ã€å¤„ç†å’Œç®¡ç†ï¼Œæ˜¯æ•´ä¸ªè§†è§‰ç³»ç»Ÿçš„æ•°æ®è¾“å…¥æºã€‚æ”¯æŒå¤šç§è§†é¢‘æºï¼ŒåŒ…æ‹¬USBæ‘„åƒå¤´ã€IPæ‘„åƒå¤´å’Œè§†é¢‘æ–‡ä»¶ï¼Œæä¾›ç¨³å®šå¯é çš„å›¾åƒæ•°æ®æµã€‚

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ ¸å¿ƒç»„ä»¶
- **ç›¸æœºç®¡ç†å™¨** (`core/camera.py`): ç›¸æœºè®¾å¤‡ç®¡ç†å’Œè§†é¢‘æµæ§åˆ¶
- **è§†é¢‘å¤„ç†å™¨** (`core/video_processor.py`): è§†é¢‘æ–‡ä»¶å¤„ç†å’Œç¼–ç 
- **å¸§ç¼“å†²ç®¡ç†**: æ™ºèƒ½å¸§ç¼“å†²å’Œå†…å­˜ç®¡ç†
- **å¤šæºæ”¯æŒ**: æ”¯æŒå¤šç§è§†é¢‘è¾“å…¥æº

### æŠ€æœ¯æ ˆ
- **OpenCV**: è§†é¢‘æ•è·å’Œå¤„ç†æ ¸å¿ƒåº“
- **Threading**: å¤šçº¿ç¨‹å¼‚æ­¥è§†é¢‘å¤„ç†
- **Queue**: çº¿ç¨‹å®‰å…¨çš„å¸§é˜Ÿåˆ—ç®¡ç†
- **NumPy**: å›¾åƒæ•°æ®å¤„ç†å’Œæ“ä½œ

## ğŸ“· ç›¸æœºç®¡ç†ç³»ç»Ÿ

### Cameraç±»
æ ¸å¿ƒç›¸æœºç®¡ç†ç»„ä»¶ï¼š

```python
class Camera:
    def __init__(self, source=0, resolution=(640, 480), fps=30):
        self.source = source              # è§†é¢‘æº
        self.resolution = resolution      # åˆ†è¾¨ç‡
        self.target_fps = fps            # ç›®æ ‡å¸§ç‡
        self.cap = None                  # OpenCV VideoCaptureå¯¹è±¡
        self.is_opened = False           # ç›¸æœºçŠ¶æ€
        self.frame_count = 0             # å¸§è®¡æ•°å™¨
        self.last_frame_time = 0         # ä¸Šä¸€å¸§æ—¶é—´æˆ³
```

### æ”¯æŒçš„è§†é¢‘æºç±»å‹

#### 1. USBæ‘„åƒå¤´
```python
# ä½¿ç”¨è®¾å¤‡ç´¢å¼•
camera = Camera(source=0)  # é»˜è®¤æ‘„åƒå¤´
camera = Camera(source=1)  # ç¬¬äºŒä¸ªæ‘„åƒå¤´

# è®¾ç½®åˆ†è¾¨ç‡å’Œå¸§ç‡
camera = Camera(source=0, resolution=(1280, 720), fps=30)
```

#### 2. IPæ‘„åƒå¤´
```python
# RTSPæµ
camera = Camera(source="rtsp://192.168.1.100:554/stream")

# HTTPæµ
camera = Camera(source="http://192.168.1.100:8080/video")
```

#### 3. è§†é¢‘æ–‡ä»¶
```python
# æœ¬åœ°è§†é¢‘æ–‡ä»¶
camera = Camera(source="path/to/video.mp4")

# æ”¯æŒçš„æ ¼å¼: MP4, AVI, MOV, MKVç­‰
```

### ç›¸æœºæ§åˆ¶åŠŸèƒ½

#### 1. åŸºæœ¬æ§åˆ¶
```python
def open(self):
    """æ‰“å¼€ç›¸æœº"""
    self.cap = cv2.VideoCapture(self.source)
    if self.cap.isOpened():
        self.configure_camera()
        self.is_opened = True
        return True
    return False

def close(self):
    """å…³é—­ç›¸æœº"""
    if self.cap and self.cap.isOpened():
        self.cap.release()
        self.is_opened = False

def read_frame(self):
    """è¯»å–å•å¸§"""
    if not self.is_opened:
        return None, None
        
    ret, frame = self.cap.read()
    if ret:
        self.frame_count += 1
        self.last_frame_time = time.time()
        return True, frame
    return False, None
```

#### 2. å‚æ•°é…ç½®
```python
def configure_camera(self):
    """é…ç½®ç›¸æœºå‚æ•°"""
    if self.cap and self.cap.isOpened():
        # è®¾ç½®åˆ†è¾¨ç‡
        self.cap.set(cv2.CAP_PROP_FRAME_WIDTH, self.resolution[0])
        self.cap.set(cv2.CAP_PROP_FRAME_HEIGHT, self.resolution[1])
        
        # è®¾ç½®å¸§ç‡
        self.cap.set(cv2.CAP_PROP_FPS, self.target_fps)
        
        # è®¾ç½®ç¼“å†²åŒºå¤§å°
        self.cap.set(cv2.CAP_PROP_BUFFERSIZE, 1)
        
        # è‡ªåŠ¨æ›å…‰å’Œç™½å¹³è¡¡
        self.cap.set(cv2.CAP_PROP_AUTO_EXPOSURE, 0.75)
        self.cap.set(cv2.CAP_PROP_AUTO_WB, 1)
```

#### 3. çŠ¶æ€ç›‘æ§
```python
def get_camera_info(self):
    """è·å–ç›¸æœºä¿¡æ¯"""
    if not self.is_opened:
        return None
        
    info = {
        'width': int(self.cap.get(cv2.CAP_PROP_FRAME_WIDTH)),
        'height': int(self.cap.get(cv2.CAP_PROP_FRAME_HEIGHT)),
        'fps': self.cap.get(cv2.CAP_PROP_FPS),
        'frame_count': self.frame_count,
        'backend': self.cap.getBackendName(),
        'is_color': bool(self.cap.get(cv2.CAP_PROP_MODE))
    }
    return info
```

## ğŸ¥ è§†é¢‘å¤„ç†å™¨

### VideoProcessorç±»
è§†é¢‘æ–‡ä»¶å¤„ç†å’Œç¼–ç ç®¡ç†ï¼š

```python
class VideoProcessor:
    def __init__(self):
        self.input_path = None
        self.output_path = None
        self.writer = None
        self.codec = 'mp4v'
        self.quality = 0.8
        
    def setup_writer(self, output_path, fps, frame_size):
        """è®¾ç½®è§†é¢‘å†™å…¥å™¨"""
        fourcc = cv2.VideoWriter_fourcc(*self.codec)
        self.writer = cv2.VideoWriter(
            output_path, fourcc, fps, frame_size
        )
        return self.writer.isOpened()
```

### è§†é¢‘å¤„ç†åŠŸèƒ½

#### 1. è§†é¢‘å½•åˆ¶
```python
def start_recording(self, output_path, fps=30, frame_size=(640, 480)):
    """å¼€å§‹å½•åˆ¶è§†é¢‘"""
    self.output_path = output_path
    return self.setup_writer(output_path, fps, frame_size)

def write_frame(self, frame):
    """å†™å…¥å¸§åˆ°è§†é¢‘æ–‡ä»¶"""
    if self.writer and self.writer.isOpened():
        self.writer.write(frame)
        return True
    return False

def stop_recording(self):
    """åœæ­¢å½•åˆ¶"""
    if self.writer:
        self.writer.release()
        self.writer = None
```

#### 2. è§†é¢‘æ ¼å¼è½¬æ¢
```python
def convert_video(self, input_path, output_path, 
                 target_fps=None, target_size=None):
    """è½¬æ¢è§†é¢‘æ ¼å¼"""
    cap = cv2.VideoCapture(input_path)
    
    # è·å–åŸå§‹å‚æ•°
    original_fps = cap.get(cv2.CAP_PROP_FPS)
    original_width = int(cap.get(cv2.CAP_PROP_FRAME_WIDTH))
    original_height = int(cap.get(cv2.CAP_PROP_FRAME_HEIGHT))
    
    # è®¾ç½®ç›®æ ‡å‚æ•°
    fps = target_fps or original_fps
    width, height = target_size or (original_width, original_height)
    
    # è®¾ç½®å†™å…¥å™¨
    self.setup_writer(output_path, fps, (width, height))
    
    # é€å¸§è½¬æ¢
    while True:
        ret, frame = cap.read()
        if not ret:
            break
            
        if target_size:
            frame = cv2.resize(frame, target_size)
            
        self.write_frame(frame)
    
    cap.release()
    self.stop_recording()
```

## ğŸ”„ å¸§ç¼“å†²ç®¡ç†

### FrameBufferç±»
æ™ºèƒ½å¸§ç¼“å†²å’Œå†…å­˜ç®¡ç†ï¼š

```python
class FrameBuffer:
    def __init__(self, max_size=10):
        self.max_size = max_size
        self.buffer = queue.Queue(maxsize=max_size)
        self.dropped_frames = 0
        self.total_frames = 0
        
    def put_frame(self, frame, timestamp=None):
        """æ·»åŠ å¸§åˆ°ç¼“å†²åŒº"""
        self.total_frames += 1
        
        if self.buffer.full():
            # ä¸¢å¼ƒæœ€æ—§çš„å¸§
            try:
                self.buffer.get_nowait()
                self.dropped_frames += 1
            except queue.Empty:
                pass
        
        frame_data = {
            'frame': frame,
            'timestamp': timestamp or time.time(),
            'frame_id': self.total_frames
        }
        
        try:
            self.buffer.put_nowait(frame_data)
            return True
        except queue.Full:
            self.dropped_frames += 1
            return False
    
    def get_frame(self, timeout=1.0):
        """ä»ç¼“å†²åŒºè·å–å¸§"""
        try:
            return self.buffer.get(timeout=timeout)
        except queue.Empty:
            return None
```

### è‡ªé€‚åº”ç¼“å†²ç­–ç•¥
```python
class AdaptiveFrameBuffer(FrameBuffer):
    def __init__(self, initial_size=5, max_size=20):
        super().__init__(max_size=initial_size)
        self.max_possible_size = max_size
        self.performance_monitor = PerformanceMonitor()
        
    def adjust_buffer_size(self):
        """æ ¹æ®æ€§èƒ½åŠ¨æ€è°ƒæ•´ç¼“å†²åŒºå¤§å°"""
        processing_time = self.performance_monitor.get_avg_processing_time()
        frame_rate = self.performance_monitor.get_frame_rate()
        
        if processing_time > 100:  # 100ms
            # å¤„ç†è¾ƒæ…¢ï¼Œå¢åŠ ç¼“å†²åŒº
            new_size = min(self.max_size + 2, self.max_possible_size)
        elif processing_time < 33:  # 33ms (30fps)
            # å¤„ç†è¾ƒå¿«ï¼Œå‡å°‘ç¼“å†²åŒº
            new_size = max(self.max_size - 1, 3)
        else:
            return
            
        self.resize_buffer(new_size)
```

## âš™ï¸ é…ç½®å‚æ•°

### ç›¸æœºé…ç½®
```python
CAMERA_CONFIG = {
    'default_source': 0,                    # é»˜è®¤è§†é¢‘æº
    'default_resolution': (640, 480),       # é»˜è®¤åˆ†è¾¨ç‡
    'default_fps': 30,                      # é»˜è®¤å¸§ç‡
    'buffer_size': 1,                       # OpenCVç¼“å†²åŒºå¤§å°
    'auto_exposure': True,                  # è‡ªåŠ¨æ›å…‰
    'auto_white_balance': True,             # è‡ªåŠ¨ç™½å¹³è¡¡
    'reconnect_attempts': 5,                # é‡è¿å°è¯•æ¬¡æ•°
    'reconnect_delay': 2.0                  # é‡è¿å»¶è¿Ÿ(ç§’)
}
```

### è§†é¢‘å¤„ç†é…ç½®
```python
VIDEO_CONFIG = {
    'default_codec': 'mp4v',               # é»˜è®¤ç¼–ç å™¨
    'quality': 0.8,                        # è§†é¢‘è´¨é‡
    'max_file_size': 1024 * 1024 * 1024,  # æœ€å¤§æ–‡ä»¶å¤§å°(1GB)
    'segment_duration': 600,               # åˆ†æ®µæ—¶é•¿(ç§’)
    'enable_hardware_encoding': True,      # ç¡¬ä»¶ç¼–ç 
    'compression_level': 6                 # å‹ç¼©çº§åˆ«
}
```

### å¸§ç¼“å†²é…ç½®
```python
BUFFER_CONFIG = {
    'default_buffer_size': 5,              # é»˜è®¤ç¼“å†²åŒºå¤§å°
    'max_buffer_size': 20,                 # æœ€å¤§ç¼“å†²åŒºå¤§å°
    'adaptive_buffering': True,            # è‡ªé€‚åº”ç¼“å†²
    'drop_frame_threshold': 0.1,           # ä¸¢å¸§é˜ˆå€¼
    'memory_limit': 512 * 1024 * 1024     # å†…å­˜é™åˆ¶(512MB)
}
```

## ğŸ› ï¸ ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ç›¸æœºä½¿ç”¨
```python
from core.camera import Camera

# åˆå§‹åŒ–ç›¸æœº
camera = Camera(source=0, resolution=(1280, 720), fps=30)

# æ‰“å¼€ç›¸æœº
if camera.open():
    print("ç›¸æœºæ‰“å¼€æˆåŠŸ")
    
    # è¯»å–å¸§
    while True:
        ret, frame = camera.read_frame()
        if ret:
            # å¤„ç†å¸§
            cv2.imshow("Camera", frame)
            if cv2.waitKey(1) & 0xFF == ord('q'):
                break
        else:
            print("è¯»å–å¸§å¤±è´¥")
            break
    
    # å…³é—­ç›¸æœº
    camera.close()
else:
    print("æ— æ³•æ‰“å¼€ç›¸æœº")
```

### è§†é¢‘å½•åˆ¶
```python
from core.camera import Camera
from core.video_processor import VideoProcessor

camera = Camera(source=0)
processor = VideoProcessor()

if camera.open():
    # å¼€å§‹å½•åˆ¶
    processor.start_recording("output.mp4", fps=30, frame_size=(640, 480))
    
    # å½•åˆ¶å¾ªç¯
    for i in range(300):  # å½•åˆ¶10ç§’(30fps)
        ret, frame = camera.read_frame()
        if ret:
            processor.write_frame(frame)
    
    # åœæ­¢å½•åˆ¶
    processor.stop_recording()
    camera.close()
```

### å¤šçº¿ç¨‹è§†é¢‘å¤„ç†
```python
import threading
from core.camera import Camera
from core.frame_buffer import FrameBuffer

class ThreadedCamera:
    def __init__(self, source=0):
        self.camera = Camera(source)
        self.buffer = FrameBuffer(max_size=10)
        self.capture_thread = None
        self.is_running = False
        
    def start_capture(self):
        """å¯åŠ¨æ•è·çº¿ç¨‹"""
        if self.camera.open():
            self.is_running = True
            self.capture_thread = threading.Thread(target=self._capture_loop)
            self.capture_thread.start()
            
    def _capture_loop(self):
        """æ•è·å¾ªç¯"""
        while self.is_running:
            ret, frame = self.camera.read_frame()
            if ret:
                self.buffer.put_frame(frame)
            else:
                time.sleep(0.01)
                
    def get_latest_frame(self):
        """è·å–æœ€æ–°å¸§"""
        return self.buffer.get_frame(timeout=0.1)
        
    def stop_capture(self):
        """åœæ­¢æ•è·"""
        self.is_running = False
        if self.capture_thread:
            self.capture_thread.join()
        self.camera.close()
```

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. ç›¸æœºæ— æ³•æ‰“å¼€
```
åŸå› : è®¾å¤‡è¢«å ç”¨æˆ–é©±åŠ¨é—®é¢˜
è§£å†³:
- æ£€æŸ¥è®¾å¤‡æ˜¯å¦è¢«å…¶ä»–ç¨‹åºå ç”¨
- æ›´æ–°ç›¸æœºé©±åŠ¨ç¨‹åº
- å°è¯•ä¸åŒçš„è®¾å¤‡ç´¢å¼•
- æ£€æŸ¥USBè¿æ¥
```

#### 2. å¸§ç‡ä¸ç¨³å®š
```
åŸå› : å¤„ç†èƒ½åŠ›ä¸è¶³æˆ–ç¼“å†²è®¾ç½®ä¸å½“
è§£å†³:
- é™ä½åˆ†è¾¨ç‡æˆ–å¸§ç‡
- è°ƒæ•´ç¼“å†²åŒºå¤§å°
- ä½¿ç”¨å¤šçº¿ç¨‹å¤„ç†
- ä¼˜åŒ–å¤„ç†ç®—æ³•
```

#### 3. è§†é¢‘å½•åˆ¶å¤±è´¥
```
åŸå› : ç¼–ç å™¨ä¸æ”¯æŒæˆ–ç£ç›˜ç©ºé—´ä¸è¶³
è§£å†³:
- æ£€æŸ¥ç£ç›˜ç©ºé—´
- å°è¯•ä¸åŒçš„ç¼–ç å™¨
- è°ƒæ•´è§†é¢‘è´¨é‡è®¾ç½®
- æ£€æŸ¥æ–‡ä»¶æƒé™
```

### è°ƒè¯•å‘½ä»¤
```bash
# æµ‹è¯•ç›¸æœº
python -m core.camera --test-camera 0

# æ£€æŸ¥å¯ç”¨ç›¸æœº
python -m core.camera --list-cameras

# å½•åˆ¶æµ‹è¯•è§†é¢‘
python -m core.camera --record --duration 10 --output test.mp4
```

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### ç›¸æœºæ€§èƒ½
- **æ”¯æŒåˆ†è¾¨ç‡**: 320x240 - 1920x1080
- **æ”¯æŒå¸§ç‡**: 1-60 FPS
- **å¯åŠ¨æ—¶é—´**: < 2ç§’
- **å†…å­˜å ç”¨**: < 100MB

### è§†é¢‘å¤„ç†æ€§èƒ½
- **å½•åˆ¶æ€§èƒ½**: å®æ—¶å½•åˆ¶æ— ä¸¢å¸§
- **æ ¼å¼è½¬æ¢**: 1080pè§†é¢‘ ~2xå®æ—¶é€Ÿåº¦
- **ç¼–ç æ•ˆç‡**: H.264ç¡¬ä»¶ç¼–ç æ”¯æŒ
- **æ–‡ä»¶å¤§å°**: 1080p@30fps ~100MB/åˆ†é’Ÿ

### ç¼“å†²æ€§èƒ½
- **ç¼“å†²å»¶è¿Ÿ**: < 100ms
- **ä¸¢å¸§ç‡**: < 1%ï¼ˆæ­£å¸¸è´Ÿè½½ï¼‰
- **å†…å­˜æ•ˆç‡**: è‡ªé€‚åº”å†…å­˜ç®¡ç†
- **å¹¶å‘æ”¯æŒ**: æ”¯æŒå¤šè·¯è§†é¢‘æµ

## ğŸ”„ æ›´æ–°æ—¥å¿—

### v1.3 (å½“å‰ç‰ˆæœ¬)
- âœ… å®ç°è‡ªé€‚åº”å¸§ç¼“å†²ç®¡ç†
- âœ… æ·»åŠ å¤šçº¿ç¨‹è§†é¢‘å¤„ç†æ”¯æŒ
- âœ… ä¼˜åŒ–ç›¸æœºå‚æ•°è‡ªåŠ¨é…ç½®
- âœ… æ”¯æŒç¡¬ä»¶ç¼–ç åŠ é€Ÿ

### v1.2
- âœ… æ·»åŠ IPæ‘„åƒå¤´æ”¯æŒ
- âœ… å®ç°è§†é¢‘æ ¼å¼è½¬æ¢
- âœ… ä¼˜åŒ–å†…å­˜ç®¡ç†

### v1.1
- âœ… åŸºç¡€ç›¸æœºæ•è·åŠŸèƒ½
- âœ… ç®€å•è§†é¢‘å½•åˆ¶
- âœ… åŸºæœ¬å‚æ•°é…ç½®

## ğŸ“š ç›¸å…³æ–‡æ¡£
- [æ£€æµ‹æ¨¡å—æ–‡æ¡£](./æ£€æµ‹æ¨¡å—.md)
- [æ·±åº¦ä¼°è®¡æ¨¡å—æ–‡æ¡£](./æ·±åº¦ä¼°è®¡æ¨¡å—.md)
- [ç³»ç»Ÿé…ç½®æ–‡æ¡£](./configuration.md)
- [æ€§èƒ½ä¼˜åŒ–æ–‡æ¡£](./performance.md)
