# BlindStar 语音模块文档

## 📖 模块概述

BlindStar语音模块提供完整的语音交互能力，包括语音识别(STT)和语音合成(TTS)功能。该模块支持离线运行，确保用户隐私和在无网络环境下的使用体验。

## 🏗️ 架构设计

### 核心组件
- **STT引擎** (`core/stt_engine.py`): 基于Vosk的离线语音识别
- **TTS引擎** (`core/tts_engine.py`): 双重备用语音合成系统
- **语音命令处理**: 集成在主系统中的命令解析和执行

### 技术栈
- **Vosk**: 轻量级离线语音识别引擎，支持高准确度中文识别
- **Windows SAPI**: 优先使用的语音合成接口（通过PowerShell调用）
- **pyttsx3**: 备用跨平台文本转语音库

## 🎤 语音识别 (STT)

### 功能特性
- **离线识别**: 完全本地化处理，保护用户隐私
- **中文支持**: 优化的中文语音识别模型
- **实时处理**: 支持连续语音识别和命令解析
- **噪声处理**: 内置噪声抑制和语音增强

### 支持的语音命令

#### 系统控制命令
```
- "开始检测" / "停止检测"
- "开始录制" / "停止录制"  
- "退出系统"
- "帮助"
```

#### POI查询命令
```
- "附近有什么餐厅"
- "查找咖啡厅"
- "附近的超市"
- "找银行"
- "查找[POI类型]"
```

#### 导航命令
```
- "导航到[地点名称]"
- "去[地点名称]"
- "开始导航" / "结束导航"
- "暂停导航" / "继续导航"
- "当前位置"
- "剩余距离"
```

#### 检测控制命令
```
- "切换模式"
- "调整灵敏度"
- "查看统计"
```

### 配置参数
```python
# STT配置
STT_CONFIG = {
    'model_path': 'models/vosk-model-cn',  # 中文模型路径
    'sample_rate': 16000,                  # 采样率
    'chunk_size': 4096,                    # 音频块大小
    'timeout': 5.0,                        # 识别超时时间
    'energy_threshold': 300,               # 能量阈值
    'dynamic_energy_threshold': True       # 动态能量调整
}
```

## 🔊 语音合成 (TTS)

### 双重备用系统
BlindStar采用双重备用TTS系统，确保语音播报的可靠性：

1. **主要系统**: Windows SAPI（通过PowerShell调用）
2. **备用系统**: pyttsx3引擎

### 功能特性
- **自动切换**: 主系统失败时自动切换到备用系统
- **语音冷却**: 防止语音播报过于频繁
- **异步播报**: 支持非阻塞语音合成
- **音量控制**: 可调节播报音量和语速

### TTS播报内容

#### 检测结果播报
```
- 物体检测: "检测到[物体名称]，距离[X]米"
- 危险警告: "注意！前方有障碍物"
- 运动物体: "[物体]正在[方向]移动，速度[X]公里/小时"
```

#### 导航播报
```
- 路径指引: "前方[X]米后左转"
- 到达提醒: "已到达目的地"
- POI信息: "找到[数量]个[类型]，最近的距离[X]米"
```

#### 系统状态播报
```
- 模式切换: "已切换到[模式名称]模式"
- 错误提示: "系统错误，请检查设备连接"
- 帮助信息: "支持的命令包括..."
```

### 配置参数
```python
# TTS配置
TTS_CONFIG = {
    'use_sapi_first': True,           # 优先使用SAPI
    'voice_rate': 200,                # 语速 (words per minute)
    'voice_volume': 0.8,              # 音量 (0.0-1.0)
    'cooldown_time': 2.0,             # 播报冷却时间(秒)
    'max_message_length': 200,        # 最大播报长度
    'enable_async': True              # 启用异步播报
}
```

## 🛠️ 使用方法

### 基本使用
```python
from core.stt_engine import STTEngine
from core.tts_engine import TTSEngine

# 初始化语音引擎
stt = STTEngine()
tts = TTSEngine()

# 启动语音识别
stt.start_listening()

# 语音播报
tts.speak("检测到汽车，距离5米")
```

### 集成使用
```python
# 在主系统中集成语音功能
class BlindStarSystem:
    def __init__(self):
        self.stt = STTEngine()
        self.tts = TTSEngine()
        
    def handle_voice_command(self, command):
        """处理语音命令"""
        if "导航到" in command:
            destination = self.extract_destination(command)
            self.start_navigation(destination)
            self.tts.speak(f"开始导航到{destination}")
```

## 🔧 故障排除

### 常见问题

#### 1. 语音识别无响应
```
原因: 麦克风权限或设备问题
解决: 检查麦克风设备和系统权限设置
```

#### 2. TTS播报无声
```
原因: 音频服务或驱动问题
解决: 
- 检查Windows音频服务状态
- 更新音频驱动程序
- 系统会自动切换到备用TTS引擎
```

#### 3. 语音识别准确率低
```
原因: 环境噪声或发音问题
解决: 
- 在安静环境中使用
- 清晰发音，适当放慢语速
- 调整能量阈值参数
```

### 调试命令
```bash
# 测试语音识别
python -m core.stt_engine

# 测试语音合成
python -m core.tts_engine

# 检查音频设备
python -c "import pyaudio; print([pyaudio.PyAudio().get_device_info_by_index(i) for i in range(pyaudio.PyAudio().get_device_count())])"
```

## 📊 性能指标

### 语音识别性能
- **识别延迟**: < 500ms
- **准确率**: 中文识别 > 90%
- **支持语言**: 中文（普通话）
- **噪声抑制**: -20dB SNR环境下正常工作

### 语音合成性能
- **合成延迟**: < 200ms
- **音质**: 16kHz采样率，清晰自然
- **稳定性**: 双重备用系统，可靠性 > 99%
- **资源占用**: CPU < 5%，内存 < 50MB

## 🔄 更新日志

### v1.3 (当前版本)
- ✅ 实现双重备用TTS系统（SAPI + pyttsx3）
- ✅ 优化语音命令解析准确率
- ✅ 添加语音播报冷却机制
- ✅ 支持异步语音合成

### v1.2
- ✅ 集成Vosk离线语音识别
- ✅ 添加中文语音命令支持
- ✅ 实现POI查询语音交互

### v1.1
- ✅ 基础TTS功能实现
- ✅ 系统状态语音播报
- ✅ 检测结果语音反馈

## 📚 相关文档
- [导航模块文档](./导航模块.md)
- [检测模块文档](./检测模块.md)
- [系统配置文档](./configuration.md)
- [故障排除指南](./troubleshooting.md)
