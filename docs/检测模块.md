# BlindStar 检测模块文档

## 📖 模块概述

BlindStar检测模块是系统的视觉感知核心，基于YOLO系列模型提供高精度的实时物体检测能力。支持YOLO11和YOLOv8模型，能够识别80种COCO类别物体，为视障用户提供准确的环境感知信息。

## 🏗️ 架构设计

### 核心组件
- **检测器** (`core/detector.py`): 核心物体检测引擎
- **帧分析器** (`core/frame_analyzer.py`): 帧级别的综合分析
- **实时视频分析器** (`core/realtime_video_analyzer.py`): 实时视频流处理
- **批量处理器** (`core/batch_processor.py`): 批量视频/图像处理
- **自定义训练模型**: 针对视障辅助场景优化的专用模型

### 技术栈
- **YOLO11/YOLOv8**: 最新的实时物体检测模型
- **Ultralytics**: 统一的YOLO模型训练和推理框架
- **PyTorch**: 深度学习推理引擎
- **OpenCV**: 图像处理和视频I/O
- **CUDA**: GPU加速推理

## 🎯 物体检测引擎

### Detector类
核心检测组件，支持多种YOLO模型：

```python
class Detector:
    def __init__(self, model_path="yolo11n.pt", device="auto"):
        self.model_path = model_path
        self.device = device
        self.model = None
        self.class_names = []
        self.confidence_threshold = 0.5
        self.iou_threshold = 0.45
```

### 支持的模型类型
- **YOLO11系列**: yolo11n.pt, yolo11s.pt, yolo11m.pt, yolo11l.pt, yolo11x.pt
- **YOLOv8系列**: yolov8n.pt, yolov8s.pt, yolov8m.pt, yolov8l.pt, yolov8x.pt
- **自定义模型**: 基于BlindStar数据集训练的专用模型

### 检测功能

#### 1. 基础物体检测
```python
def detect_objects(self, image, confidence=0.5):
    """检测图像中的物体"""
    results = self.model(image, conf=confidence)
    detections = []
    
    for result in results:
        boxes = result.boxes
        if boxes is not None:
            for box in boxes:
                detection = {
                    'bbox': box.xyxy[0].cpu().numpy(),
                    'confidence': box.conf[0].cpu().numpy(),
                    'class_id': int(box.cls[0].cpu().numpy()),
                    'class_name': self.class_names[int(box.cls[0])]
                }
                detections.append(detection)
    
    return detections
```

#### 2. 批量检测
```python
def detect_batch(self, images, confidence=0.5):
    """批量检测多张图像"""
    results = self.model(images, conf=confidence)
    batch_detections = []
    
    for result in results:
        # 处理每张图像的检测结果
        detections = self.process_single_result(result)
        batch_detections.append(detections)
    
    return batch_detections
```

## 🎥 实时视频分析

### RealtimeVideoAnalyzer类
实时视频流处理和分析：

```python
class RealtimeVideoAnalyzer:
    def __init__(self, detector, distance_calculator):
        self.detector = detector
        self.distance_calculator = distance_calculator
        self.frame_queue = queue.Queue(maxsize=10)
        self.result_queue = queue.Queue(maxsize=10)
        self.is_running = False
```

### 实时处理流程
1. **视频捕获**: 从摄像头或视频文件获取帧
2. **预处理**: 图像尺寸调整和格式转换
3. **物体检测**: YOLO模型推理
4. **深度估计**: 距离计算和深度分析
5. **结果融合**: 检测结果与深度信息结合
6. **后处理**: 结果过滤和优化

### 性能优化
- **多线程处理**: 分离捕获、检测和显示线程
- **帧跳跃**: 根据处理能力动态调整帧率
- **批量推理**: 多帧批量处理提高效率
- **内存管理**: 智能缓存和内存回收

## 📊 帧分析器

### FrameAnalyzer类
单帧的综合分析和处理：

```python
class FrameAnalyzer:
    def __init__(self, detector, distance_calc, risk_assessor):
        self.detector = detector
        self.distance_calc = distance_calc
        self.risk_assessor = risk_assessor
        self.analysis_history = []
```

### 分析维度

#### 1. 物体检测分析
```python
def analyze_detections(self, detections):
    """分析检测结果"""
    analysis = {
        'total_objects': len(detections),
        'object_categories': {},
        'high_confidence_objects': [],
        'potential_risks': []
    }
    
    for detection in detections:
        category = detection['class_name']
        analysis['object_categories'][category] = \
            analysis['object_categories'].get(category, 0) + 1
            
        if detection['confidence'] > 0.8:
            analysis['high_confidence_objects'].append(detection)
    
    return analysis
```

#### 2. 空间分布分析
```python
def analyze_spatial_distribution(self, detections, image_shape):
    """分析物体空间分布"""
    height, width = image_shape[:2]
    
    # 将图像分为9个区域
    regions = {
        'top_left': [], 'top_center': [], 'top_right': [],
        'middle_left': [], 'middle_center': [], 'middle_right': [],
        'bottom_left': [], 'bottom_center': [], 'bottom_right': []
    }
    
    for detection in detections:
        region = self.get_object_region(detection['bbox'], width, height)
        regions[region].append(detection)
    
    return regions
```

#### 3. 运动分析
```python
def analyze_motion(self, current_detections, previous_detections):
    """分析物体运动"""
    motion_analysis = {
        'moving_objects': [],
        'stationary_objects': [],
        'new_objects': [],
        'disappeared_objects': []
    }
    
    # 物体关联和运动计算
    associations = self.associate_detections(
        current_detections, previous_detections
    )
    
    for current, previous in associations:
        motion = self.calculate_motion(current, previous)
        if motion['speed'] > 0.5:  # 0.5 m/s 阈值
            motion_analysis['moving_objects'].append({
                'detection': current,
                'motion': motion
            })
        else:
            motion_analysis['stationary_objects'].append(current)
    
    return motion_analysis
```

## 🏷️ 支持的检测类别

### COCO-80类别
BlindStar支持完整的COCO数据集80个类别：

#### 人员类别
```
- person (人员)
```

#### 车辆类别
```
- car (汽车)
- truck (卡车) 
- bus (公交车)
- motorcycle (摩托车)
- bicycle (自行车)
```

#### 交通设施
```
- traffic light (交通灯)
- stop sign (停车标志)
```

#### 动物类别
```
- bird (鸟类)
- cat (猫)
- dog (狗)
- horse (马)
- sheep (羊)
- cow (牛)
- elephant (大象)
- bear (熊)
- zebra (斑马)
- giraffe (长颈鹿)
```

#### 日常物品
```
- backpack (背包)
- umbrella (雨伞)
- handbag (手提包)
- tie (领带)
- suitcase (行李箱)
- chair (椅子)
- couch (沙发)
- bed (床)
- dining table (餐桌)
- toilet (马桶)
```

### 自定义类别扩展
针对视障辅助场景的专用类别：

```python
BLINDSTAR_CUSTOM_CLASSES = {
    'crosswalk': '人行横道',
    'stairs': '楼梯', 
    'curb': '路缘',
    'railing': '栏杆',
    'guide_arrows': '导向箭头',
    'red_light': '红灯',
    'green_light': '绿灯',
    'snow': '积雪',
    'water': '积水'
}
```

## ⚙️ 配置参数

### 检测模型配置
```python
DETECTION_CONFIG = {
    'model_path': 'models/yolo11s.pt',      # 模型路径
    'device': 'cuda:0',                     # 设备选择
    'confidence_threshold': 0.5,            # 置信度阈值
    'iou_threshold': 0.45,                  # NMS IoU阈值
    'max_detections': 100,                  # 最大检测数量
    'input_size': 640,                      # 输入图像尺寸
    'half_precision': True,                 # 半精度推理
    'batch_size': 1                         # 批处理大小
}
```

### 实时处理配置
```python
REALTIME_CONFIG = {
    'target_fps': 30,                       # 目标帧率
    'max_queue_size': 10,                   # 最大队列大小
    'skip_frames': 0,                       # 跳帧数量
    'enable_threading': True,               # 启用多线程
    'buffer_size': 3,                       # 缓冲区大小
    'timeout': 5.0                          # 处理超时时间
}
```

### 类别过滤配置
```python
CLASS_FILTER_CONFIG = {
    'enabled_classes': [                    # 启用的类别
        'person', 'car', 'truck', 'bus', 
        'motorcycle', 'bicycle', 'traffic light'
    ],
    'priority_classes': [                   # 优先级类别
        'person', 'car', 'traffic light'
    ],
    'ignore_classes': [                     # 忽略的类别
        'remote', 'keyboard', 'mouse'
    ],
    'confidence_by_class': {                # 按类别设置置信度
        'person': 0.3,
        'car': 0.5,
        'traffic light': 0.7
    }
}
```

## 🛠️ 使用方法

### 基本检测使用
```python
from core.detector import Detector

# 初始化检测器
detector = Detector(model_path="yolo11s.pt", device="cuda")

# 加载图像
image = cv2.imread("test_image.jpg")

# 执行检测
detections = detector.detect_objects(image, confidence=0.5)

# 处理结果
for detection in detections:
    print(f"检测到: {detection['class_name']}, "
          f"置信度: {detection['confidence']:.2f}")
```

### 实时视频检测
```python
from core.realtime_video_analyzer import RealtimeVideoAnalyzer
from core.detector import Detector
from core.distance import DistanceCalculator

# 初始化组件
detector = Detector("yolo11s.pt")
distance_calc = DistanceCalculator()
analyzer = RealtimeVideoAnalyzer(detector, distance_calc)

# 开始实时分析
analyzer.start_analysis(source=0)  # 使用摄像头

# 获取结果
while analyzer.is_running:
    result = analyzer.get_latest_result()
    if result:
        print(f"检测到 {len(result['detections'])} 个物体")
```

### 批量处理
```python
from core.batch_processor import BatchProcessor

# 初始化批量处理器
processor = BatchProcessor(detector)

# 处理视频文件
results = processor.process_video(
    input_path="input_video.mp4",
    output_path="output_video.mp4",
    save_analysis=True
)

print(f"处理完成，共分析 {results['total_frames']} 帧")
```

## 🔧 故障排除

### 常见问题

#### 1. 检测精度低
```
原因: 模型不适合当前场景或置信度阈值不当
解决:
- 使用更大的模型(如yolo11l.pt)
- 调整置信度阈值
- 使用自定义训练模型
- 改善光照条件
```

#### 2. 检测速度慢
```
原因: 硬件性能不足或配置不当
解决:
- 使用更小的模型(如yolo11n.pt)
- 启用半精度推理
- 调整输入图像尺寸
- 使用GPU加速
```

#### 3. 内存占用过高
```
原因: 批处理大小过大或缓存设置不当
解决:
- 减小batch_size
- 调整队列大小
- 启用内存回收
- 使用较小的输入尺寸
```

### 调试命令
```bash
# 测试检测器
python -m core.detector --test-image test.jpg

# 测试实时检测
python -m core.realtime_video_analyzer --source 0

# 性能基准测试
python -m core.detector --benchmark --model yolo11s.pt
```

## 📊 性能指标

### 检测精度 (COCO数据集)
- **YOLO11n**: mAP50: 39.5%, mAP50-95: 26.4%
- **YOLO11s**: mAP50: 47.0%, mAP50-95: 32.1%
- **YOLO11m**: mAP50: 51.5%, mAP50-95: 36.6%
- **YOLO11l**: mAP50: 53.2%, mAP50-95: 38.3%

### 推理速度 (RTX 5060 Laptop)
- **YOLO11n**: ~120 FPS
- **YOLO11s**: ~80 FPS  
- **YOLO11m**: ~50 FPS
- **YOLO11l**: ~30 FPS

### 自定义模型性能
- **总体mAP50**: 0.637
- **优秀类别**: red_light (0.979), crosswalk (0.975), green_light (0.968)
- **待改进类别**: railing (0.155), curb (0.18), snow (0.282)

## 🔄 更新日志

### v1.3 (当前版本)
- ✅ 集成YOLO11最新模型
- ✅ 完成自定义模型训练(50轮，mAP50: 0.637)
- ✅ 优化实时检测性能
- ✅ 添加批量处理功能

### v1.2
- ✅ 支持YOLOv8系列模型
- ✅ 实现多线程实时处理
- ✅ 添加类别过滤功能

### v1.1
- ✅ 基础YOLO检测功能
- ✅ 简单的结果可视化
- ✅ 基本的配置管理

## 📚 相关文档
- [深度估计模块文档](./深度估计模块.md)
- [避障模块文档](./避障模块.md)
- [语音模块文档](./语音模块.md)
- [模型训练指南](./DEPTH_ANNOTATION_GUIDE.md)
